{{- if .Values.gpuNodeConfig.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: gpu-node-config-scripts
  labels:
    {{- include "nvidia-platform.labels" . | nindent 4 }}
data:
  acs_disable.sh: |
    #!/bin/bash
    # Copyright (c) 2020, NVIDIA Corporation. MIT License.
    # Modified by Nscale 2026
    # Disable P2P specific ACS bits on every device that supports it

    if [ "$EUID" -ne 0 ]; then
        echo "ERROR: $0 must be run as root" >&2
        exit 1
    fi

    if ! command -v lspci >/dev/null 2>&1 || ! command -v setpci >/dev/null 2>&1; then
        echo "ERROR: lspci/setpci not found. Install pciutils." >&2
        exit 1
    fi

    for BDF in $(lspci -d "*:*:*" | awk '{print $1}'); do
        output=$(setpci -v -s ${BDF} ECAP_ACS+0x6.w 2>&1)
        if [ $? -ne 0 ]; then
            echo "${BDF} does not support ACS, skipping"
            continue
        fi
        OLD_VAL=$(echo "$output" | awk '{print $NF}')
        echo "${BDF} supports ACS, current value is $OLD_VAL"
        echo "Disabling ACS on $(lspci -s ${BDF})"
        setpci -v -s ${BDF} ECAP_ACS+0x6.w=0000 > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "Error disabling ACS on ${BDF}" >&2
            continue
        fi
        NEW_VAL=$(setpci -v -s ${BDF} ECAP_ACS+0x6.w | awk '{print $NF}')
        if [ "${NEW_VAL}" != "0000" ]; then
            echo "Failed to disable ACS on ${BDF}. Value was ${NEW_VAL}, expected 0000. Starting value was $OLD_VAL."
            continue
        fi
        echo "Successfully disabled ACS on ${BDF}."
    done
    exit 0
  iommu_passthrough.sh: |
    #!/bin/bash
    # Verify IOMMU is in passthrough mode (iommu=pt kernel param).
    # This must be set in the node image; the script will fail if it is missing.

    if grep -q 'iommu=pt' /proc/cmdline; then
      echo "iommu=pt already set."
      exit 0
    fi

    echo "ERROR: iommu=pt is NOT set in kernel cmdline. This must be configured in the node image."
    exit 1
  entrypoint.sh: |
    #!/bin/bash
    set -e

    /tmp/iommu_passthrough.sh
    /tmp/acs_disable.sh

    echo "gpu-node-config complete, sleeping."
    sleep infinity
{{- end }}
